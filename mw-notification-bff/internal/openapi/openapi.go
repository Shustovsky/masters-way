package openapi

import (
	openapiNotification "mw-notification-bff/apiAutogenerated/mw-notification"
	openapiNotificationBFF "mw-notification-bff/apiAutogenerated/mw-notification-bff"
	"mw-notification-bff/internal/auth"
	"mw-notification-bff/internal/config"
	"net/http"
)

type authTransport struct {
	rt http.RoundTripper
}

func (t *authTransport) RoundTrip(req *http.Request) (*http.Response, error) {
	ctx := req.Context()
	if token, ok := ctx.Value(auth.ContextKeyAuthorization).(string); ok {
		req.Header.Set(auth.HeaderKeyAuthorization, token)
	}
	return t.rt.RoundTrip(req)
}

func MakeNotificationAPIClient(cfg *config.Config) *openapiNotification.APIClient {
	notificationAPIConfig := &openapiNotification.Configuration{
		Host:   cfg.NotificationAPIHost,
		Scheme: "http",
		Servers: openapiNotification.ServerConfigurations{
			{
				URL:         cfg.NotificationBaseURL,
				Description: "mw-notification",
			},
		},
		HTTPClient: &http.Client{
			Transport: &authTransport{rt: http.DefaultTransport},
		},
	}
	return openapiNotification.NewAPIClient(notificationAPIConfig)
}

func MakeNotificationBFFAPIClient(cfg *config.Config) *openapiNotificationBFF.APIClient {
	chatBFFAPIConfig := &openapiNotificationBFF.Configuration{
		Host:   cfg.TestGeneralBffAPIHost,
		Scheme: "http",
		Servers: openapiNotificationBFF.ServerConfigurations{
			{
				URL:         cfg.TestGeneralBffAPIBaseUrl,
				Description: "mw-notification-bff",
			},
		},
		HTTPClient: &http.Client{
			Transport: &authTransport{rt: http.DefaultTransport},
		},
	}
	return openapiNotificationBFF.NewAPIClient(chatBFFAPIConfig)
}
